{% load i18n %}
<script type="text/javascript" language="javascript">
   var fk_urls=[];
   var fk_number=0;
   var cambios_en_estado=[];
   var id_lockers_cambiados=[];
    /***Add the necessary HTML to the page with the elements of Lockers table
     * VERIFICAR SI EL CONTENIDO PUESTO EN LA COLUMNA DE HORA ES CORRETO***/
   $(document).ready(
    $.getJSON("/Lockers/?format=json", function (data) {
        var items="";
        var Estatus="";
        $(data).each(function(index,content){
            items+="<tr id=locker_"+content.locker_id+">";
            items+="<td>"+content.locker_id+"</td>";
            items+="<td>"+content.locker_name+"</td>";
            items+="<td>"+content.locker_status+"</td>";
            var date=new Date(content.locker_start_time)
            var d=""+date.getDay()+"/"+date.getMonth()+"/"+date.getFullYear();
            items+="<td>"+d+"</td>";
            items+="<td>"+date.getHours()+":"+date.getMinutes()+"</td>"+"<td id=fk"+fk_number+"></td>";
            if (content.locker_status=="Disponible"){
                Estatus="checked";
            }
            else
                Estatus="unchecked";
            items+='<td>' +
                        '<div class="switch">' +
                            '<input class ="switch"id="CheckBox_'+content.locker_id+'" '+Estatus+' onclick="lockerCambiaEstatus('+content.locker_id+',this)" type="checkbox">' +
                            '<label for="CheckBox_'+content.locker_id+'"></label>' +
                        '</div>'+
                    '</td>';
            fk_urls.push(content.fk_area);
            fk_number++;
            items+="</tr>";

        });
        (document).getElementById("table_body").innerHTML=items;
        fk_searh();
    })
    );

   /***Esta función va guardando los cambios en el estatus en una variable global***/
   function lockerCambiaEstatus(row_id,checkbox){
       var elementos=[];
       var row=(document).getElementById("locker_"+row_id).cells;
       var locker=''+row_id;
       if (id_lockers_cambiados.indexOf(locker) == -1){
           if(checkbox.checked)
            cambios_en_estado.push("Disponible");
           else
            cambios_en_estado.push("No Disponible");
           id_lockers_cambiados.push(""+row_id);
       }
       else{
           var index_of_element=id_lockers_cambiados.indexOf(""+row_id);
           id_lockers_cambiados.splice(index_of_element,1);
           cambios_en_estado.splice(index_of_element,1);
       }


   }
   /***Esta función aplica los cambios realizados en el Estatus del locker,
    * Realiza un GET a la BD y en el codigo de success realiza un POST cambiando los datos del Estatus***/


    function lockerAplicarCambios(){
    for(var c= 0,actual_locker=0;c<id_lockers_cambiados.length;c++){
        actual_locker=id_lockers_cambiados[c];
        (function(actual_locker) { // protects url and actual_fk parameters
            $.getJSON("/Lockers/"+actual_locker+"/", function (data) {
                data.locker_status=cambios_en_estado[id_lockers_cambiados.indexOf(actual_locker)];
                $.ajax({
                  url: "/Lockers/"+actual_locker+"/",
                  type: "PUT",
                  dataType: "json",
                  data: {"locker_id": data.locker_id,
                         "locker_name": data.locker_name,
                          "locker_status": data.locker_status,
                          "locker_start_time": data.locker_start_time,
                          "fk_area": data.fk_area},
                  success: function (data) {
                        location.reload(true);
                  },
                  error: function(e) {
                       console.log(e);
                  }
                });
            });
            })(actual_locker);

    }

   }

   /***This method search the fk_area of Lockers in Area table, and add it to the HTML
    * It ***/
   function fk_searh(){
       for(var actual_fk= 0,url="";actual_fk<fk_number;actual_fk++) {
           url=""+fk_urls[actual_fk]+"?format=json";
           (function(url,actual_fk) { // protects url and actual_fk parameters
            $.getJSON(url, function (data) {
                $("#fk"+actual_fk).append(data.area_id);
            });
            })(url,actual_fk);
       }
   }


</script>